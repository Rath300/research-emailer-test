{% extends "base.html" %}

{% block title %}Emails - Cold Outreach AI Matchmaker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-envelope text-primary me-2"></i>
            Email Management
        </h2>
        <p class="text-muted">
            Review and send personalized emails to your matched startups.
        </p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    Email Batch Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary">{{ batch.total_matches }}</h4>
                            <small class="text-muted">Total Emails</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success">{{ "%.2f"|format(batch.average_score) }}</h4>
                            <small class="text-muted">Average Match Score</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ batch.matches|selectattr('auto_send', 'equalto', true)|list|length }}</h4>
                            <small class="text-muted">Auto-Send Ready</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ batch.generated_at.split('T')[0] }}</h4>
                            <small class="text-muted">Generated Date</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list text-primary me-2"></i>
                    Generated Emails
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="selectAll()">
                        <i class="fas fa-check-square me-1"></i>Select All
                    </button>
                    <button class="btn btn-success btn-sm" onclick="sendSelectedEmails()">
                        <i class="fas fa-paper-plane me-1"></i>Send Selected
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% for match in batch.matches %}
                <div class="card mb-3 email-item">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title">{{ match.company_name }}</h6>
                                        <p class="text-muted mb-2">
                                            {{ match.contact_name }} • {{ match.contact_email }}
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <div class="match-score {{ 'high' if match.match_score >= 0.8 else 'medium' if match.match_score >= 0.6 else 'low' }}">
                                            {{ "%.1f"|format(match.match_score * 100) }}%
                                        </div>
                                        {% if match.auto_send %}
                                        <span class="badge bg-success">Auto-Send</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Subject:</strong> {{ match.subject_line }}
                                </div>
                                
                                <div class="mb-3">
                                    <button class="btn btn-sm btn-outline-primary email-preview-toggle">
                                        <i class="fas fa-eye me-1"></i>Preview Email
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary copy-btn" 
                                            data-clipboard-text="Subject: {{ match.subject_line }}

{{ match.email_body }}">
                                        <i class="fas fa-copy me-1"></i>Copy
                                    </button>
                                </div>
                                
                                <div class="email-preview" style="display: none;">
                                    <strong>Subject:</strong> {{ match.subject_line }}
                                    <hr>
                                    {{ match.email_body }}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input email-checkbox" type="checkbox" 
                                           value="{{ loop.index0 }}" id="email{{ loop.index0 }}">
                                    <label class="form-check-label" for="email{{ loop.index0 }}">
                                        Send this email
                                    </label>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Match Rationale:</strong><br>
                                        {{ match.rationale.reasoning[:100] }}...
                                    </small>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Relevant Projects:</strong><br>
                                        {% for project in match.relevant_projects[:2] %}
                                            • {{ project }}<br>
                                        {% endfor %}
                                        {% if match.relevant_projects|length > 2 %}
                                            ... and {{ match.relevant_projects|length - 2 }} more
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Email Configuration Modal -->
<div class="modal fade" id="emailConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Please configure your email settings before sending emails.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">SMTP Server</label>
                    <input type="text" class="form-control" id="smtpServer" placeholder="smtp.gmail.com">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">SMTP Port</label>
                    <input type="number" class="form-control" id="smtpPort" placeholder="587">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="emailAddress" placeholder="your@email.com">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Password/App Password</label>
                    <input type="password" class="form-control" id="emailPassword" placeholder="Your password">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEmailConfig()">Save Configuration</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectAll() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
}

function sendSelectedEmails() {
    const selectedEmails = Array.from(document.querySelectorAll('.email-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedEmails.length === 0) {
        showToast('Please select at least one email to send', 'warning');
        return;
    }
    
    // Check if email configuration exists
    if (!localStorage.getItem('emailConfig')) {
        $('#emailConfigModal').modal('show');
        return;
    }
    
    if (confirm(`Send ${selectedEmails.length} emails?`)) {
        $.ajax({
            url: '/api/send-emails',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                email_indices: selectedEmails
            }),
            success: function(response) {
                if (response.success) {
                    showToast(`Successfully sent ${selectedEmails.length} emails!`, 'success');
                    // Uncheck sent emails
                    selectedEmails.forEach(index => {
                        document.querySelector(`#email${index}`).checked = false;
                    });
                } else {
                    showToast('Error sending emails: ' + response.error, 'danger');
                }
            },
            error: function() {
                showToast('Error sending emails', 'danger');
            }
        });
    }
}

function saveEmailConfig() {
    const config = {
        smtp_server: $('#smtpServer').val(),
        smtp_port: $('#smtpPort').val(),
        email_address: $('#emailAddress').val(),
        email_password: $('#emailPassword').val()
    };
    
    localStorage.setItem('emailConfig', JSON.stringify(config));
    $('#emailConfigModal').modal('hide');
    showToast('Email configuration saved!', 'success');
}

// Load email configuration on page load
$(document).ready(function() {
    const config = localStorage.getItem('emailConfig');
    if (config) {
        const parsed = JSON.parse(config);
        $('#smtpServer').val(parsed.smtp_server);
        $('#smtpPort').val(parsed.smtp_port);
        $('#emailAddress').val(parsed.email_address);
    }
});
</script>
{% endblock %} 