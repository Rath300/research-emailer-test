{% extends "base.html" %}

{% block title %}AI Cold Outreach System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">ü§ñ AI-Powered Autonomous Outreach</h1>
            {% if ai_type == 'REAL_AI' %}
            <div class="badge bg-success">üß† REAL AI MODE: GPT-4 + Sentence Transformers</div>
            {% else %}
            <div class="badge bg-secondary">ü§ñ DEMO MODE: Simulated AI Agents</div>
            {% endif %}
        </div>
        <button class="btn btn-dark" id="run-all-btn">Run Full Campaign</button>
    </div>

    <!-- Progress Bar -->
    <div class="progress mb-4" style="height: 8px; background-color: #f1f1f1;">
        <div class="progress-bar bg-dark" role="progressbar" style="width: 25%;" id="workflow-progress"></div>
    </div>

    <div class="row">
        <!-- Step 1: AI Web Scraping -->
        <div class="col-12 mb-4" id="step-1">
            <div class="card border">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span><strong>Step 1:</strong> AI Web Scraping Agent</span>
                    <span class="badge bg-light text-dark border" id="scrape-status">Ready</span>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Data Sources</h6>
                    <div class="mb-4">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="source-ycombinator" value="ycombinator" checked>
                            <label class="form-check-label" for="source-ycombinator">Y Combinator (AI Agent)</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="source-producthunt" value="producthunt">
                            <label class="form-check-label" for="source-producthunt">Product Hunt (AI Agent)</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="source-angellist" value="angellist" disabled>
                            <label class="form-check-label text-muted" for="source-angellist">AngelList (Coming Soon)</label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="scrape-limit" class="form-label">Startups per source: <strong id="scrape-limit-value">30</strong></label>
                        <input type="range" class="form-range" min="10" max="100" step="10" id="scrape-limit" value="30">
                        <div class="d-flex justify-content-between text-muted small">
                            <span>10</span>
                            <span>100</span>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="use-cache-switch">
                        <label class="form-check-label" for="use-cache-switch">Use cached data (last 24h)</label>
                    </div>

                    <button class="btn btn-dark" id="run-scrape-btn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        Deploy Scraping Agent
                    </button>
                    <div id="scrape-results" class="mt-3 text-muted"></div>
                </div>
            </div>
        </div>

        <!-- Step 2: AI Matching Agent -->
        <div class="col-12 mb-4 d-none" id="step-2">
            <div class="card border">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span><strong>Step 2:</strong> AI Semantic Matching Agent</span>
                    <span class="badge bg-light text-dark border" id="match-status">Waiting</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-light border">AI agent will analyze your profile and match with relevant startups using advanced semantic analysis.</div>
                    
                    <div class="mb-4">
                        <label for="match-method" class="form-label">AI Matching Method</label>
                        <select class="form-select border" id="match-method">
                            <option value="ai_prompt" selected>GPT-4 AI Prompt Analysis</option>
                            <option value="semantic">Semantic Similarity (Embeddings)</option>
                            <option value="hybrid">Hybrid AI + Semantic</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="match-count" class="form-label">Top matches to email: <strong id="match-count-value">10</strong></label>
                        <input type="range" class="form-range" min="5" max="50" step="5" id="match-count" value="10">
                        <div class="d-flex justify-content-between text-muted small">
                            <span>5</span>
                            <span>50</span>
                        </div>
                    </div>

                    <button class="btn btn-dark" id="run-match-btn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        Deploy Matching Agent
                    </button>
                    <div id="match-results" class="mt-3 text-muted"></div>
                </div>
            </div>
        </div>

        <!-- Step 3: AI Email Generation Agent -->
        <div class="col-12 mb-4 d-none" id="step-3">
            <div class="card border">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span><strong>Step 3:</strong> AI Email Generation Agent</span>
                    <span class="badge bg-light text-dark border" id="email-status">Waiting</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-light border">AI agent will generate personalized cold emails using GPT-4 based on match analysis.</div>
                    
                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" role="switch" id="review-emails-switch" checked>
                        <label class="form-check-label" for="review-emails-switch">Review emails before sending</label>
                    </div>
                    
                    <button class="btn btn-dark" id="generate-emails-btn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        Deploy Email Generation Agent
                    </button>
                    <div id="email-results" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <!-- Step 4: AI Email Dispatch Agent -->
        <div class="col-12 mb-4 d-none" id="step-4">
            <div class="card border">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span><strong>Step 4:</strong> AI Email Dispatch Agent</span>
                    <span class="badge bg-light text-dark border" id="send-status">Waiting</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-light border">AI agent will dispatch emails and generate comprehensive campaign analytics.</div>
                    <button class="btn btn-dark" id="send-emails-btn" disabled>
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        Deploy Dispatch Agent
                    </button>
                    <a href="#" class="btn btn-outline-dark d-none ms-2" id="download-report-btn">
                        Download Campaign Report
                    </a>
                    <div id="send-results" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fix slider value display
    const scrapeLimit = document.getElementById('scrape-limit');
    const scrapeLimitValue = document.getElementById('scrape-limit-value');
    scrapeLimit.addEventListener('input', function() {
        scrapeLimitValue.textContent = scrapeLimit.value;
    });

    const matchCount = document.getElementById('match-count');
    const matchCountValue = document.getElementById('match-count-value');
    matchCount.addEventListener('input', function() {
        matchCountValue.textContent = matchCount.value;
    });

    // Helper functions
    function toggleSpinner(btnId, show) {
        const btn = document.getElementById(btnId);
        const spinner = btn.querySelector('.spinner-border');
        btn.disabled = show;
        if (show) {
            spinner.classList.remove('d-none');
        } else {
            spinner.classList.add('d-none');
        }
    }

    function updateStatus(elementId, text, type) {
        const elem = document.getElementById(elementId);
        elem.textContent = text;
        elem.className = `badge border ${type === 'success' ? 'bg-dark text-white' : type === 'warning' ? 'bg-light text-dark' : 'bg-light text-dark'}`;
    }
    
    function updateProgress(percentage) {
        document.getElementById('workflow-progress').style.width = percentage + '%';
    }
    
    // Step 1: AI Web Scraping Agent
    document.getElementById('run-scrape-btn').addEventListener('click', function() {
        toggleSpinner('run-scrape-btn', true);
        updateStatus('scrape-status', 'AI Agent Working...', 'warning');
        document.getElementById('scrape-results').innerHTML = '<div class="text-muted">ü§ñ AI scraping agent deployed, gathering startup data...</div>';

        // Get selected sources
        const sources = [];
        if (document.getElementById('source-ycombinator').checked) sources.push('ycombinator');
        if (document.getElementById('source-producthunt').checked) sources.push('producthunt');
        
        const limit = parseInt(document.getElementById('scrape-limit').value);
        const useCache = document.getElementById('use-cache-switch').checked;

        // Call AI Agent API
        fetch('/api/outreach/scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sources: sources,
                limit: limit,
                use_cache: useCache
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('scrape-results').innerHTML = `<div class="text-dark">‚úì AI Agent: ${data.message}</div>`;
                updateStatus('scrape-status', 'Complete', 'success');
                document.getElementById('step-2').classList.remove('d-none');
                updateProgress(50);
            } else {
                document.getElementById('scrape-results').innerHTML = `<div class="text-danger">‚ùå Error: ${data.error}</div>`;
                updateStatus('scrape-status', 'Failed', 'error');
            }
            toggleSpinner('run-scrape-btn', false);
        })
        .catch(error => {
            document.getElementById('scrape-results').innerHTML = `<div class="text-danger">‚ùå Network Error: ${error.message}</div>`;
            updateStatus('scrape-status', 'Failed', 'error');
            toggleSpinner('run-scrape-btn', false);
        });
    });

    // Step 2: AI Matching Agent
    document.getElementById('run-match-btn').addEventListener('click', function() {
        toggleSpinner('run-match-btn', true);
        updateStatus('match-status', 'AI Agent Analyzing...', 'warning');
        document.getElementById('match-results').innerHTML = '<div class="text-muted">ü§ñ AI matching agent analyzing semantic compatibility...</div>';

        const method = document.getElementById('match-method').value;
        const matchCountVal = parseInt(document.getElementById('match-count').value);

        // Call AI Matching Agent API
        fetch('/api/outreach/match', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                method: method,
                match_count: matchCountVal
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('match-results').innerHTML = `<div class="text-dark">‚úì AI Agent: ${data.message}</div>`;
                updateStatus('match-status', 'Complete', 'success');
                document.getElementById('step-3').classList.remove('d-none');
                updateProgress(75);
            } else {
                document.getElementById('match-results').innerHTML = `<div class="text-danger">‚ùå Error: ${data.error}</div>`;
                updateStatus('match-status', 'Failed', 'error');
            }
            toggleSpinner('run-match-btn', false);
        })
        .catch(error => {
            document.getElementById('match-results').innerHTML = `<div class="text-danger">‚ùå Network Error: ${error.message}</div>`;
            updateStatus('match-status', 'Failed', 'error');
            toggleSpinner('run-match-btn', false);
        });
    });

    // Step 3: AI Email Generation Agent
    document.getElementById('generate-emails-btn').addEventListener('click', function() {
        toggleSpinner('generate-emails-btn', true);
        updateStatus('email-status', 'AI Agent Generating...', 'warning');
        document.getElementById('email-results').innerHTML = '<div class="text-muted">ü§ñ AI email generation agent crafting personalized messages...</div>';

        // Call AI Email Generation Agent API
        fetch('/api/outreach/generate-emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let emailsHtml = `<div class="text-dark mb-3">‚úì AI Agent: ${data.message}</div>`;
                
                if (data.emails && data.emails.length > 0) {
                    emailsHtml += '<div class="border rounded p-3 bg-light">';
                    data.emails.forEach((email, index) => {
                        emailsHtml += `
                            <div class="d-flex justify-content-between mb-2">
                                <strong>${email.startup_name}</strong>
                                <span class="badge bg-dark">Match: ${email.match_score}%</span>
                            </div>
                            <div class="text-muted small mb-2">Subject: ${email.subject}</div>
                        `;
                        if (index < data.emails.length - 1) emailsHtml += '<hr>';
                    });
                    emailsHtml += '</div>';
                }
                
                document.getElementById('email-results').innerHTML = emailsHtml;
                updateStatus('email-status', 'Complete', 'success');
                document.getElementById('send-emails-btn').disabled = false;
                document.getElementById('step-4').classList.remove('d-none');
                updateProgress(100);
            } else {
                document.getElementById('email-results').innerHTML = `<div class="text-danger">‚ùå Error: ${data.error}</div>`;
                updateStatus('email-status', 'Failed', 'error');
            }
            toggleSpinner('generate-emails-btn', false);
        })
        .catch(error => {
            document.getElementById('email-results').innerHTML = `<div class="text-danger">‚ùå Network Error: ${error.message}</div>`;
            updateStatus('email-status', 'Failed', 'error');
            toggleSpinner('generate-emails-btn', false);
        });
    });

    // Step 4: AI Email Dispatch Agent
    document.getElementById('send-emails-btn').addEventListener('click', function() {
        toggleSpinner('send-emails-btn', true);
        updateStatus('send-status', 'AI Agent Dispatching...', 'warning');
        document.getElementById('send-results').innerHTML = '<div class="text-muted">ü§ñ AI dispatch agent sending emails and generating analytics...</div>';

        // Call AI Email Dispatch Agent API
        fetch('/api/outreach/send-emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('send-results').innerHTML = `
                    <div class="text-dark mb-2">‚úì AI Agent: ${data.message}</div>
                    <div class="small text-muted">Success Rate: ${data.success_rate.toFixed(1)}%</div>
                `;
                updateStatus('send-status', 'Complete', 'success');
                document.getElementById('download-report-btn').classList.remove('d-none');
                document.getElementById('download-report-btn').href = `/uploads/${data.report_file}`;
            } else {
                document.getElementById('send-results').innerHTML = `<div class="text-danger">‚ùå Error: ${data.error}</div>`;
                updateStatus('send-status', 'Failed', 'error');
            }
            toggleSpinner('send-emails-btn', false);
        })
        .catch(error => {
            document.getElementById('send-results').innerHTML = `<div class="text-danger">‚ùå Network Error: ${error.message}</div>`;
            updateStatus('send-status', 'Failed', 'error');
            toggleSpinner('send-emails-btn', false);
        });
    });

    // Run Full Campaign
    document.getElementById('run-all-btn').addEventListener('click', function() {
        document.getElementById('run-scrape-btn').click();
        
        // Chain the operations
        const checkAndRunNext = (step, nextBtn, delay) => {
            const interval = setInterval(() => {
                const status = document.getElementById(step + '-status').textContent;
                if (status === 'Complete') {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById(nextBtn).click();
                    }, delay);
                } else if (status === 'Failed') {
                    clearInterval(interval);
                }
            }, 1000);
        };
        
        checkAndRunNext('scrape', 'run-match-btn', 1000);
        checkAndRunNext('match', 'generate-emails-btn', 1000);
        checkAndRunNext('email', 'send-emails-btn', 1000);
    });
});
</script>
{% endblock %} 